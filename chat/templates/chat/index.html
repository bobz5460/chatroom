<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
	<meta charset="UTF-8">
	<title>Notes - Google Docs</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
</head>

<body>


<div class="alert alert-warning alert-dismissible fade show" role="alert">
  Please note: this project is IN DEVELOPMENT and will have frequent changes. Messages are (semi)UNENCRYPTED. ANYONE(kinda) CAN SEE YOUR MESSAGES. Messages are stored on a server controlled by Bobby, unencrypted. My server is easily exploitable so use at your own risk. For for info, go to (do this later)
  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>



<div class="container-fluid" style="margin-top: 0; padding-top: 0; margin-bottom: 0; padding-bottom: 0;">
  <div class="row">
    <div class="col-md-11">
      <!-- main -->
      <div class="border border-bottom-0" id="message-view" style="height: 90vh; overflow-y: auto; margin-top: 1vh; margin-bottom: 0;">
        <ul class="list-group" id="messages"></ul>
      </div>
	    <div class="border border-top-0 p-3" style="margin-top: 0; margin-bottom: 1vh;">
          <form method="post" autocomplete="off">
            <input class="form-control" type="text" placeholder="Send a message..." id="chat-message-input" name="Message">
          </form>
        </div>
    </div>
	<!-- sidebar -->
    <div class="col-md-1 border-start" style="padding-top: 1vh;">
      <h5>Active</h5>
      <ul class="list-group" id="active_users">

      </ul>
    </div>
  </div>
</div>


{{ room_name|json_script:"room-name" }}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
</body>



<script>
	let name;
    let msgs_loaded = -1; //account for system message
    window.onload=function() {
		scrollToBottom();
    }
    const roomName = JSON.parse(document.getElementById('room-name').textContent);

    const chatSocket = new WebSocket(
        'ws://'
        + window.location.host
        + '/ws/chat/'
        + roomName
        + '/'
    );
    const input = document.getElementById('chat-message-input');
    const submit = document.getElementById('chat-message-submit');
	
    function scrollToBottom() {
        const container = document.getElementById("message-view");
        container.scrollTop = container.scrollHeight;
    }
    function sendMessage() {
        let message = input.value;
        chatSocket.send(JSON.stringify({
	        'message': message,
	        'type': 'message'
        }));
        input.value = "";
        console.log(message);
    }

       //if we need to load older messages
	const messages = document.getElementById("message-view");


	messages.addEventListener("scroll", () => {
	    if (messages.scrollTop === 0) {
            console.log("Loading older messages...");
            chatSocket.send(JSON.stringify({
		    'type': 'load_messages',
			'msgs_loaded': msgs_loaded
    }));

	    }
	});
    //chatSocket.send(JSON.stringify({
	//    'type': 'load_messages',
	//	'msgs_loaded': msgs_loaded
    //}))

	const form = document.querySelector('form');
	form.addEventListener('submit', (e) => {
	    e.preventDefault();
	    sendMessage();
	    console.log(msgs_loaded);
	    return false;
	});

	chatSocket.onmessage = function(event){
        const data = JSON.parse(event.data);
		const messages = document.getElementById("messages");
        const li = document.createElement("li");
        li.className = "list-group-item";
        li.textContent = data.user + ": " + data.message;
        if (data.type === "message"){
	        messages.append(li);
	        console.log("Message received:" + data.message)
			scrollToBottom();
            msgs_loaded +=1;
        }
        else if (data.type === "old_message"){
			const container = document.getElementById("message-view");
            const top = container.scrollTop;
            const scrollHeight = container.scrollHeight;
            messages.prepend(li);
            container.scrollTop = top+ (container.scrollHeight - scrollHeight);
            msgs_loaded +=1;
        }
        else if (data.type === "users") {
            document.getElementById("active_users").innerHTML = "";
            for (const user of data.users) {
				const user_li = document.createElement("li");
				user_li.className = "list-group-item";
				user_li.textContent = user;
				document.getElementById("active_users").append(user_li);
			}
        }
	}
    chatSocket.onerror = function(event){
        const li = document.createElement("li");
        li.className = "list-group-item";
        li.textContent = "An error occurred. Please refresh the page.";
        messages.append(li);
    }
    chatSocket.onclose = function(event){
                const li = document.createElement("li");
        li.className = "list-group-item";
        li.textContent = "Websocket disconnected! Please refresh the page.";
        messages.append(li);
    }

</script>
</html>